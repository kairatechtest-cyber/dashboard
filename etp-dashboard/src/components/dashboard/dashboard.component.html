

<div class="flex h-screen">
  <!-- Sidebar -->
  <aside class="w-64 flex-shrink-0 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col">
    <!-- Sidebar Header -->
    <div class="h-16 flex items-center gap-3 px-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
      <svg class="w-8 h-8 text-emerald-400" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M8 16a6 6 0 0 0 6-6c0-1.655-1.122-2.904-2.432-4.362C10.254 4.176 8.75 2.503 8 0c0 0-6 5.686-6 10a6 6 0 0 0 6 6zM6.646 4.646c-.376.377-1.272 1.489-2.093 3.13l.894.448c.78-1.559 1.616-2.58 1.907-2.87l-.708-.708z"/>
      </svg>
      <h1 class="text-xl font-bold text-gray-900 dark:text-white">KAIRA Technologies</h1>
    </div>
    <!-- Navigation -->
    <nav class="flex-grow p-4 space-y-2">
      @for(link of navLinks; track link.path) {
        <a 
          [routerLink]="link.path"
          routerLinkActive="bg-emerald-500 text-white dark:bg-gray-700"
          [routerLinkActiveOptions]="{ exact: true }"
          class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" [attr.d]="link.icon" />
          </svg>
          <span>{{ link.label }}</span>
          @if (link.path === 'alerts' && notificationCount() > 0) {
            <span class="ml-auto flex h-5 w-5 items-center justify-center rounded-full bg-red-600 text-xs font-bold text-white">
              {{ notificationCount() }}
            </span>
          }
        </a>
      }
    </nav>
  </aside>

  <!-- Main Content Area -->
  <div class="flex-1 flex flex-col overflow-y-auto relative">
    <!-- Sticky Top Bar -->
    <div class="sticky top-0 flex items-center justify-between bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm z-20 border-b border-gray-200 dark:border-gray-700 px-6 h-16">
      <!-- Search Bar -->
      <div class="w-full max-w-xs">
        <form [formGroup]="searchForm" class="relative">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3">
            <svg class="w-5 h-5 text-gray-400 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
          </span>
          <input 
            type="search" 
            formControlName="query" 
            (input)="onSearchInput()"
            (focus)="openSearch()"
            placeholder="Search dashboard..." 
            class="w-full bg-gray-200 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-md p-2 pl-10 focus:ring-emerald-500 focus:border-emerald-500 placeholder-gray-500 dark:placeholder-gray-400 text-sm">
        </form>
      </div>

      <!-- Controls and Header -->
      <div class="flex items-center gap-4">
        <!-- Refresh Rate Selector -->
        <div class="flex items-center gap-2">
          @if (isRefreshing()) {
            <svg class="animate-spin h-5 w-5 text-emerald-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          }
          <label for="refreshRate" class="text-sm font-medium text-gray-500 dark:text-gray-400">Refresh Rate:</label>
          <select 
            id="refreshRate" 
            [value]="selectedRefreshRate()" 
            (change)="onRefreshRateChange($event)"
            class="bg-gray-200 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-md p-1.5 focus:ring-emerald-500 focus:border-emerald-500">
            @for (option of refreshOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
        </div>
        
        <!-- Theme Toggle Button -->
        <button 
          (click)="themeService.toggleTheme()"
          class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-900 focus:ring-emerald-500 transition-colors">
          @if (themeService.theme() === 'dark') {
            <!-- Sun Icon for Light Mode -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          } @else {
            <!-- Moon Icon for Dark Mode -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          }
        </button>

        <!-- User Profile Header Component -->
        <app-header></app-header>
      </div>
    </div>

    <!-- Child Route Content -->
    <main class="p-6">
      <router-outlet />
    </main>
  </div>
</div>

<!-- Global Search Modal -->
@if (isSearchOpen()) {
  <div class="fixed inset-0 bg-black/60 z-[60]" (click)="closeSearch()"></div>
  <div class="fixed top-16 left-1/2 -translate-x-1/2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-b-lg shadow-2xl p-4 w-full max-w-2xl z-[70] max-h-[50vh] overflow-y-auto">
    @if (isSearching()) {
      <div class="flex justify-center items-center p-8">
        <svg class="animate-spin h-8 w-8 text-emerald-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
    } @else {
      @if (searchResults().length > 0) {
        <ul class="space-y-2">
          @for(result of searchResults(); track $index) {
            <li (click)="navigateToResult(result)" class="p-3 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors">
              <div class="flex justify-between items-center">
                <p class="font-semibold text-gray-900 dark:text-white">{{ result.title }}</p>
                <span class="text-xs font-medium bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded-full">{{ result.category }}</span>
              </div>
              @if (result.context) {
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">{{ result.context }}</p>
              }
            </li>
          }
        </ul>
      } @else {
        <div class="text-center p-8">
          <p class="text-gray-500 dark:text-gray-400">
            @if(searchForm.value.query) {
              <span>No results found for "<strong>{{ searchForm.value.query }}</strong>".</span>
            } @else {
              <span>Start typing to search KPIs, parameters, and alerts.</span>
            }
          </p>
        </div>
      }
    }
  </div>
}
